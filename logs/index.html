<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Apache log visualizer</title>

    <!-- Le styles -->
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <style>
      body
      {
        padding-top: 15px;
      }

      #map_canvas img {
        max-width: none;
      }
    </style>

    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">
    var map;
    var markers = [];
    var markerAttribs = [];
    var domains = [];
    var iterator = 0;
    var xmlDoc = "";

    function initialize()
    {
      var request = new XMLHttpRequest();
      var mapOptions = {
        zoom: 2,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: new google.maps.LatLng(25.0, 0.0) 
      };

      map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

      request.open("GET", "data.xml", true);
      request.onreadystatechange = function()
      {
        if (request.readyState == 4)
        {
          var parser = new DOMParser();
          xmlDoc = parser.parseFromString(request.responseText, "text/xml");
          var domains = xmlDoc.documentElement.getElementsByTagName("domain");
          var totNum = xmlDoc.documentElement.getElementsByTagName("marker").length;

          $('#domainsList').append('<option value="all">All (' + totNum + ')</option>');
          $.each(domains, function(index, value)
            {
              var domain = domains[index].getAttribute("name");
              var num = domains[index].getElementsByTagName("marker").length;
              $('#domainsList').append('<option value="' + domain + '">' + domain + ' (' + num + ')</option>');
            }
          );

          //buildMarkers(xmlDoc, "all");
        }
      }
      request.send(null);
    }

    function buildMarkers(xmlDoc, domain)
    {
      var markerData = [];
      if (domain == "all")
        markerData = xmlDoc.documentElement.getElementsByTagName("marker");
      else
      {
        var domainTags = xmlDoc.documentElement.getElementsByTagName("domain");
        for (var i = 0; i < domainTags.length; i++)
        {
          if (domainTags[i].getAttribute("name") == domain)
          {
            var theMarkers = domainTags[i].getElementsByTagName("marker");
            for (var j = 0; j < theMarkers.length; j++)
              markerData.push(theMarkers[j]);
          }
        }
      }

      for (var i = 0; i < markerData.length; i++)
      {
        var lat       = parseFloat(markerData[i].getAttribute("lat"));
        var lng       = parseFloat(markerData[i].getAttribute("lng"));
        var point     = new google.maps.LatLng(lat, lng);

        markerAttribs[point] = []
        markerAttribs[point]['ip']        = markerData[i].getAttribute("ip");
        markerAttribs[point]['city']      = markerData[i].getAttribute("city");
        markerAttribs[point]['region']    = markerData[i].getAttribute("region");
        markerAttribs[point]['country']   = markerData[i].getAttribute("country");
        markerAttribs[point]['postal']    = markerData[i].getAttribute("postal");
        markerAttribs[point]['date']      = markerData[i].getAttribute("date");
        markerAttribs[point]['request']   = markerData[i].getAttribute("request");
        markerAttribs[point]['referer']   = markerData[i].getAttribute("referer");
        markerAttribs[point]['useragent'] = markerData[i].getAttribute("useragent");

        var marker = new google.maps.Marker({
          map: map,
          draggable: false,
          animation: google.maps.Animation.DROP,
          position: point
        });

        google.maps.event.addListener(marker, 'click', function(e)
        {
          document.getElementById("details").innerHTML =
            details(
              markerAttribs[e.latLng]['ip'],
              markerAttribs[e.latLng]['city'],
              markerAttribs[e.latLng]['region'],
              markerAttribs[e.latLng]['country'],
              markerAttribs[e.latLng]['postal'],
              markerAttribs[e.latLng]['date'],
              markerAttribs[e.latLng]['request'],
              markerAttribs[e.latLng]['referer'],
              markerAttribs[e.latLng]['useragent']
            );
        });

        markers.push(marker);
      }
    }

    function clearMarkers()
    {
      $.each(markers, function(index, value)
        {
          markers[index].setMap(null);
        }
      );
    }

    function details(ip, city, region, country, postal, date, request, referer, useragent)
    {
      var htmlstring = "";
      htmlstring += "<tr> <td class=\"infos\">Who</td> <td>" + ip + "</td> </tr>";
      htmlstring += "<tr> <td class=\"infos\">When</td> <td>" + date + "</td> </tr>";
      htmlstring += "<tr> <td class=\"infos\">Where</td> <td>" + city + ", " + region + ", " + country + ", " + postal + "</td> </tr>";
      htmlstring += "<tr> <td class=\"infos\">What</td> <td>" + request + "</td> </tr>";
      htmlstring += "<tr> <td class=\"infos\">Whence</td> <td>" + referer + "</td> </tr>";
      htmlstring += "<tr> <td class=\"infos\">How</td> <td>" + useragent + "</td> </tr>";
      return htmlstring;
    }

    $(document).ready(function()
      {
        $('#domainsList').change(function()
          {
            clearMarkers();
            buildMarkers(xmlDoc, $('#domainsList option:selected').val());
          }
        );
      }
    );
  </script>
  <style>
    table td.infos
    {
      text-align: right;
      width: 50px;
      font-weight: bold;
    }
  </style>
</head>
<body onload="initialize()">
  <div class="container">
    <div class="row">
      <div class="span12">
        &nbsp;
        <div class="row">
          <div class="span8">
            <div id="map_canvas" style="height: 600px;"></div>
          </div>

          <!-- donate -->
          <div class="span4>
            <h5>Referring domain:</h5>
            <select id="domainsList">
              <option></option>
            </select>
            <h5>More info:</h5>
            <table class="table table-condensed table-striped well" style="width: 100%">
              <tbody id="details">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
